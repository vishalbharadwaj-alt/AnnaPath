<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AnnaPath ‚Äì AI Ingredient Health Analyzer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <div class="brand">
      <img src="assets/logo1.png" alt="AnnaPath logo" class="logo">
      <span class="brand-name">AnnaPath</span>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="hero">
    <div class="hero-text">
      <h1>Understand What You Eat üåø</h1>
      <p>
        AnnaPath helps you decode ingredients and understand
        whether a product is suitable for your health.
      </p>
      <button class="primary-btn">Analyze Ingredients</button>
    </div>
    <div class="hero-image">
      <img src="assets/hero.png" alt="Ingredient analysis illustration">
    </div>
  </section>

  <!-- AFTER HERO SECTION -->
  <section class="after-hero">
    <div class="after-hero-image">
      <img src="assets/afterhero.svg" alt="How AnnaPath works">
    </div>
    <div class="after-hero-text">
      <h2>üß† How AnnaPath Helps You</h2>
      <p>
        Food labels are confusing. Scientific names make it harder.
        AnnaPath uses AI to explain ingredients in simple language
        and highlights what matters for <strong>you</strong>.
      </p>
    </div>
  </section>

  <section class="analyzer" id="analyzer-section">
    <h2>üßæ Analyze Your Food</h2>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button id="mode-text" class="secondary-btn active-mode" style="border: 2px solid #28a745;">Text Ingredients</button>
        <button id="mode-image" class="secondary-btn">Image Scan</button>
    </div>

    <div id="input-container-text">
        <label for="ingredients" class="visually-hidden">Ingredients</label>
        <textarea id="ingredients" aria-label="Ingredients list" placeholder="Paste ingredients here (e.g. Sugar, Salt, Palm Oil)..."></textarea>
    </div>

    <div id="input-container-image" hidden>
        <label for="imagePath" style="display:block; margin-bottom:5px; font-weight:bold;">Image File Path:</label>
        <input type="text" id="imagePath" placeholder="C:/Users/Name/Pictures/food.jpg" 
               style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px;">
        <p style="font-size: 0.8rem; color: #666;">Note: Enter the local file path for the n8n workflow to read.</p>
    </div>

    <label for="health" class="visually-hidden">Target audience</label>
    <select id="health" style="margin-top: 10px;">
      <option value="" disabled selected>üéØ Who is this food for?</option>
      <option value="general">General</option>
      <option value="diabetes">Diabetes</option>
      <option value="hypertension">High Blood Pressure</option>
      <option value="allergy">Allergy</option>
    </select>

    <div class="analyzer-row">
      <div class="webhook-config">
        <label for="webhook-url" class="visually-hidden">Webhook URL</label>
        <input id="webhook-url" placeholder="Webhook URL (Text default: Port 3001 | Image default: Port 5678)" aria-label="Webhook URL">
      </div>
    </div>

    <div class="action-row">
      <button id="analyze-btn" class="primary-btn" type="button">üîç Analyze</button>
      <button id="clear-btn" class="secondary-btn" type="button">Clear</button>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="results" id="results" role="region" aria-live="polite" aria-label="AI Insight">
    <h2>üìä AI Insight</h2>

    <p class="empty">No results yet ‚Äî paste ingredients above and click Analyze.</p>

    <div class="loading" id="loading" hidden>Analyzing‚Ä¶</div>
    <div id="results-list"></div>

    <div id="ai-details" hidden>
      <h3>AI Summary</h3>
      <div id="ai-summary"></div>
      <div id="summary"></div>
      <div id="risk-score"></div>
      <div id="ai-bullets"></div>
      <div id="details"></div>
    </div>

    <p class="uncertainty" id="uncertainty" hidden>ü§î AI note: Effects depend on quantity and individual health conditions.</p>
  </section>

  <!-- FOOTER -->
  <footer>
    <p>
      AnnaPath is for educational purposes only.  
      Always consult a healthcare professional.
    </p>
  </footer>

  <div id="app">
    <div class="food-tool">
      <label for="food-select">Choose a food:</label>
      <select id="food-select">
        <option value="">Loading foods‚Ä¶</option>
      </select>
      <button id="refresh-foods" class="secondary-btn" title="Refresh">Refresh</button>
      <button id="send-food-to-webhook" class="secondary-btn">Send ingredients to webhook</button>
    </div>

    <h3>Result:</h3>
    <pre id="output">Response will appear here...</pre>

    <h3>Food details</h3>
    <div id="food-details">Select a food to view details.</div>
  </div>

  <script>
    // --- UI TOGGLE LOGIC ---
    const modeTextBtn = document.getElementById('mode-text');
    const modeImageBtn = document.getElementById('mode-image');
    const containerText = document.getElementById('input-container-text');
    const containerImage = document.getElementById('input-container-image');
    let currentMode = 'text'; // 'text' or 'image'

    modeTextBtn.addEventListener('click', () => {
        currentMode = 'text';
        containerText.hidden = false;
        containerImage.hidden = true;
        modeTextBtn.style.border = "2px solid #28a745";
        modeImageBtn.style.border = "1px solid #ccc";
    });

    modeImageBtn.addEventListener('click', () => {
        currentMode = 'image';
        containerText.hidden = true;
        containerImage.hidden = false;
        modeImageBtn.style.border = "2px solid #28a745";
        modeTextBtn.style.border = "1px solid #ccc";
    });

    // --- MAIN ANALYZE FUNCTION ---
    async function handleAnalysis() {
        const resultSection = document.getElementById('ai-details');
        const emptyMsg = document.getElementById('empty-msg');
        const loader = document.getElementById('loader');
        const customWebhook = document.getElementById('webhook-url').value;
        const outputPre = document.getElementById('output');

        // Reset UI
        resultSection.hidden = true;
        emptyMsg.hidden = true;
        loader.classList.remove('hidden');
        loader.hidden = false;

        try {
            let url, payload;

            if (currentMode === 'text') {
                // --- TEXT MODE (Uses Mock Server or Custom) ---
                const textVal = document.getElementById('ingredients').value;
                if (!textVal) throw new Error("Please paste ingredients first!");

                // Default to Port 3001 (Mock) if no URL provided
                url = customWebhook || 'http://localhost:3001/webhook/ingest';
                payload = { 
                    text: textVal,
                    medicalHistory: [document.getElementById('health').value || "general"]
                };

            } else {
                // --- IMAGE MODE (Uses n8n Production Webhook) ---
                const pathVal = document.getElementById('imagePath').value;
                if (!pathVal) throw new Error("Please enter an image file path!");

                // Default to Port 5678 (Real n8n) if no URL provided
                // REPLACE THIS WITH YOUR ACTUAL N8N WEBHOOK TEST URL IF DIFFERENT
                url = customWebhook || 'http://localhost:5678/webhook-test/your-webhook-id'; 
                
                payload = {
                    image_path: pathVal,
                    question: "Analyze the nutritional value of this dish."
                };
            }

            // Send Request
            console.log(`Sending to ${url}...`, payload);
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Server Error (${response.status}): ${errText}`);
            }

            // Parse Response and normalize n8n/workflow outputs
            const contentType = (response.headers.get("content-type") || '').toLowerCase();
            let raw;
            if (contentType.includes("application/json")) {
                raw = await response.json();
            } else {
                // Fallback for plain text
                const text = await response.text();
                raw = { summaryPlainText: text, riskScore: 0, bullets: [] };
            }

            // Normalize common n8n / webhook response shapes:
            // - [ { body: {...} } ]  (n8n often returns array of items)
            // - { body: {...} } or { json: {...} }
            // - { output: {...} } or { result: {...} }
            let data = raw;
            try {
                if (Array.isArray(raw) && raw.length > 0) {
                    const first = raw[0];
                    if (first.body && typeof first.body === 'object') data = first.body;
                    else if (first.json && typeof first.json === 'object') data = first.json;
                    else if (first.output && typeof first.output === 'object') data = first.output;
                    else data = first;
                } else if (raw && typeof raw === 'object') {
                    if (raw.body && typeof raw.body === 'object') data = raw.body;
                    else if (raw.json && typeof raw.json === 'object') data = raw.json;
                    else if (raw.output && typeof raw.output === 'object') data = raw.output;
                    else if (raw.data && Array.isArray(raw.data) && raw.data[0]) data = raw.data[0];
                }
            } catch (e) {
                console.warn('Normalization failed, using raw response', e);
                data = raw;
            }

            // --- RENDER RESULTS ---
            renderResults(data);

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
            emptyMsg.hidden = false;
            emptyMsg.innerText = "Error: " + err.message;
        } finally {
            loader.hidden = true;
            loader.classList.add('hidden');
        }
    }

    function renderResults(data) {
        const resultSection = document.getElementById('ai-details');
        const summaryEl = document.getElementById('summary');
        const riskEl = document.getElementById('risk-score');
        const detailsEl = document.getElementById('details');
        const outputPre = document.getElementById('output');

            // 1. Text Summary
        // Accept many common keys that workflows may return
        const summaryText = data.summaryPlainText || data.output || data.summary || data.summary_text || data.result || data.text || data.description || (typeof data === 'string' ? data : "Analysis complete.");
        summaryEl.innerText = summaryText;

        // 2. Risk Score
        const riskVal = data.riskScore || data.risk_score || data.risk || data.score;
        if (typeof riskVal !== 'undefined') {
            riskEl.innerText = `Risk Level: ${riskVal}%`;
            riskEl.style.color = (Number(riskVal) > 50) ? '#dc3545' : '#28a745';
        } else {
            riskEl.innerText = "";
        }

        // 3. Bullets / Highlights
        const bullets = data.bullets || data.highlights || data.points || data.items || [];
        if (Array.isArray(bullets) && bullets.length > 0) {
            detailsEl.innerHTML = `<ul style="margin-top:10px; padding-left:20px;">${bullets.map(b => `<li>${b}</li>`).join('')}</ul>`;
        } else {
            detailsEl.innerHTML = "";
        }

        // 4. Raw Output (for debugging) ‚Äî show the original response too for traceability
        outputPre.innerText = JSON.stringify(raw || data, null, 2);

        // Show Section
        resultSection.hidden = false;
        document.getElementById('uncertainty').hidden = false;
    }

    // --- EVENT LISTENERS ---
    document.getElementById('analyze-btn').addEventListener('click', handleAnalysis);
    
    document.getElementById('clear-btn').addEventListener('click', () => {
        document.getElementById('ingredients').value = '';
        document.getElementById('imagePath').value = '';
        document.getElementById('ai-details').hidden = true;
        document.getElementById('empty-msg').hidden = false;
        document.getElementById('empty-msg').innerText = "No results yet ‚Äî enter data above and click Analyze.";
    });

    // --- DATABASE TOOLS (Keep existing logic) ---
    async function fetchFoods() {
        const select = document.getElementById('food-select');
        const details = document.getElementById('food-details');
        select.innerHTML = '<option value="">Loading‚Ä¶</option>';
        details.innerText = 'Checking mock DB‚Ä¶';
        try {
            // Default to Mock Server on 3001. If user intentionally set the webhook to the mock server (contains 3001), use that base.
            const webhookInput = document.getElementById('webhook-url');
            let apiBase = 'http://localhost:3001';
            if (webhookInput && webhookInput.value && webhookInput.value.includes('3001')) {
                apiBase = webhookInput.value.replace(/\/webhook.*$/,'');
            }
            const url = `${apiBase}/db/foods`;
            console.log('fetchFoods: requesting', url);

            // Add a small timeout for the fetch so UI doesn't hang forever
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);

            const resp = await fetch(url, { signal: controller.signal, mode: 'cors' });
            clearTimeout(timeoutId);

            if (!resp.ok) {
                const txt = await resp.text().catch(() => '');
                throw new Error(`HTTP ${resp.status}: ${txt || resp.statusText}`);
            }

            const foods = await resp.json();
            select.innerHTML = '<option value="">‚Äî Select a food ‚Äî</option>';
            foods.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.food_id;
                opt.text = `${f.food_name}`;
                select.appendChild(opt);
            });
            details.innerText = '';
        } catch (err) {
            console.error('fetchFoods error:', err);
            select.innerHTML = '<option>DB Offline (Port 3001)</option>';
            if (err.name === 'AbortError') {
                details.innerText = `Error fetching foods: request timed out (tried ${apiBase}/db/foods)`;
            } else {
                details.innerText = `Error fetching foods: ${err.message} (URL: ${apiBase}/db/foods)`;
            }
        }
    }


    // DB item -> analyze (fills text and runs text-mode analysis)
    document.getElementById('send-food-to-webhook').addEventListener('click', async () => {
        const id = document.getElementById('food-select').value;
        if (!id) return alert('Choose a food first');
        try {
            const webhookInput = document.getElementById('webhook-url');
            // Default to mock DB on port 3001 unless the webhook URL explicitly points at 3001
            let apiBase = 'http://localhost:3001';
            if (webhookInput && webhookInput.value && webhookInput.value.includes('3001')) {
                apiBase = webhookInput.value.replace(/\/webhook.*$/,'');
            }
            const resp = await fetch(`${apiBase}/db/foods/${id}`);
            if (!resp.ok) { const text = await resp.text(); throw new Error(`HTTP ${resp.status}: ${text}`); }
            const data = await resp.json();
            const ingredients = (data.ingredients || []).map(i => i.common_name).join(', ');
            document.getElementById('ingredients').value = ingredients;
            currentMode = 'text';
            handleAnalysis();
        } catch (e) {
            document.getElementById('food-details').innerText = `Error preparing webhook payload: ${e.message}`;
        }
    });

    // Auto-load DB on start
    window.addEventListener('load', fetchFoods);

  </script>
</body>
</html>
